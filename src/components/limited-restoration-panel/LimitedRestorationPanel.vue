<template id="limited-restoration-panel">
  <v-radio-group
    v-model="radioValue"
    class="mt-0 pt-0 ml-8"
    mandatory
  >
    <v-radio
      id="radio-24"
      class="pt-2"
      color="#1976d2"
      label="2 years"
      value="24"
    />
    <v-radio
      id="radio-18"
      color="#1976d2"
      label="18 months"
      value="18"
    />
    <v-radio
      id="radio-12"
      color="#1976d2"
      label="12 months"
      value="12"
    />
    <v-radio
      id="radio-6"
      color="#1976d2"
      label="6 months"
      value="6"
    />
    <v-row class="ml-0 mt-0 pt-2">
      <v-radio
        id="radio-custom"
        class="mt-n4"
        color="#1976d2"
        value="customMonths"
        inline
      />
      <v-form ref="monthsRef">
        <v-text-field
          id="text-field-months"
          v-model="inputValue"
          class="text-field-months"
          type="number"
          density="compact"
          variant="filled"
          hide-spin-buttons
          :rules="monthsRules"
          :disabled="(radioValue !== 'customMonths')"
          @update:model-value="onMonthsInput($event)"
        />
      </v-form>
      <span class="ml-2 mt-2 month-text">month(s)</span>
    </v-row>
  </v-radio-group>
</template>

<script lang="ts">
import { Component, Emit, Prop, Watch, Vue } from 'vue-facing-decorator'
import { FormIF } from '@bcrs-shared-components/interfaces'

@Component({})
export default class LimitedRestorationPanel extends Vue {
  // Refs
  $refs!: Vue['$refs'] & {
    monthsRef: FormIF
  }

  @Prop({ required: true }) readonly months!: number
  @Prop({ default: 24 }) readonly maxNumberOfMonths!: number

  // Local properties
  radioValue = '' // v-model for radio buttons
  inputValue = '' // v-model for months text field

  /**
   * The validation rules for months input.
   */
  get monthsRules (): Array<(v: string) => boolean | string> {
    return [
      (v) => (+v > 0 && +v <= this.maxNumberOfMonths) || 'Must be between 1 and ' + this.maxNumberOfMonths,
      (v) => (+v % 1 === 0) || 'Must be a whole number'
    ]
  }

  /**
   * Called when the component is mounted.
   * Sets the initial radio button and months input (if applicable).
   */
  mounted (): void {
    if ([24, 18, 12, 6].includes(this.months)) {
      this.radioValue = this.months.toString()
    } else {
      this.radioValue = 'customMonths'
      this.inputValue = this.months.toString()
    }
  }

  /**
   * Called when months input has changed.
   */
  async onMonthsInput (input: string): Promise<void> {
    // ignore non-inputs
    if (input !== null) {
      // wait for component updates
      await this.$nextTick()
      // validate the input
      const valid = this.$refs.monthsRef.validate()
      // emit validity
      this.emitValid(valid)
      // if valid, emit new value
      if (valid) this.emitMonths(Number(this.inputValue))
    }
  }

  /**
   * Called when radio button has changed.
   */
  @Watch('radioValue')
  private onRadioValueChanged () {
    if (this.radioValue !== 'customMonths') {
      // reset months text field when another radio button is selected
      this.$refs.monthsRef.reset()
      // emit months and validity
      this.emitMonths(Number(this.radioValue))
      this.emitValid(true)
    } else if (!this.inputValue) {
      // as there is no input value, this component is invalid
      // otherwise, validation will be done in onMonthsInput()
      this.emitValid(false)
    }
  }

  /**
   * Emits the numbed of months selected.
   */
  @Emit('months')
  // eslint-disable-next-line @typescript-eslint/no-unused-vars
  private emitMonths (months: number): void {}

  /**
   * Emits whether the number of months selected is valid.
   */
  @Emit('valid')
  // eslint-disable-next-line @typescript-eslint/no-unused-vars
  private emitValid (valid: boolean): void {}
}
</script>

<style lang="scss" scoped>
@import '@/assets/styles/theme.scss';
.month-text {
  color: $gray7;
}

:deep() {
  // change border style to solid before the selection of the radio button
  .theme--light.v-text-field.v-input--is-disabled .v-input__slot:before {
    border-image: none;
  }

  // decrease the month text field's width
  .text-field-months {
    width: 3.5rem;
    .v-input__details{
      width: 200px;
      padding-left: 2px;
    }
  }
}
</style>
