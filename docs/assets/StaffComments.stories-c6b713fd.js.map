{"version":3,"file":"StaffComments.stories-c6b713fd.js","sources":["../../src/components/staff-comments/StaffComments.vue"],"sourcesContent":["<template>\n  <div\n    id=\"staff-comments\"\n    class=\"d-inline\"\n  >\n    <!-- NB: attach the menu to component div so we can unit test it -->\n    <v-menu\n      v-model=\"showComments\"\n      bottom\n      attach=\"#staff-comments\"\n      :nudge-top=\"nudgeTop\"\n      :nudge-left=\"nudgeLeft\"\n      :close-on-click=\"false\"\n      :close-on-content-click=\"false\"\n    >\n      <!-- the button -->\n      <template #activator=\"{ on, attrs }\">\n        <v-btn\n          id=\"comments-button\"\n          small\n          text\n          color=\"primary\"\n          v-bind=\"attrs\"\n          v-on=\"on\"\n        >\n          <v-icon medium>\n            mdi-comment-text-outline\n          </v-icon>\n          <span>{{ numComments }}</span>\n        </v-btn>\n      </template>\n\n      <!-- the menu (panel) -->\n      <v-card\n        id=\"staff-comment-container\"\n        flat\n        class=\"px-8 py-6\"\n      >\n        <v-card-title class=\"d-flex justify-space-between pa-0\">\n          <div>\n            <v-icon\n              medium\n              color=\"primary\"\n            >\n              mdi-comment-text-outline\n            </v-icon>\n            <span>{{ numComments }}</span>\n          </div>\n          <v-btn\n            id=\"close-button\"\n            icon\n            large\n            class=\"mr-n3\"\n            @click=\"close()\"\n          >\n            <v-icon color=\"primary\">\n              mdi-close\n            </v-icon>\n          </v-btn>\n        </v-card-title>\n\n        <v-card-text class=\"mt-2 pa-0\">\n          <v-textarea\n            ref=\"textarea\"\n            v-model=\"comment\"\n            autofocus\n            no-resize\n            filled\n            rows=\"5\"\n            placeholder=\"Enter Comments\"\n            :rules=\"rules\"\n          />\n        </v-card-text>\n\n        <v-card-actions class=\"d-flex justify-space-between pa-0\">\n          <div class=\"text-body-2 mt-1\">\n            {{ charsRemaining }}\n          </div>\n          <div class=\"mr-n3\">\n            <v-btn\n              id=\"save-button\"\n              text\n              color=\"primary\"\n              class=\"font-weight-bold\"\n              :loading=\"isSaving\"\n              @click=\"save()\"\n            >\n              Save\n            </v-btn>\n            <v-btn\n              id=\"cancel-button\"\n              text\n              color=\"primary\"\n              @click=\"close()\"\n            >\n              Cancel\n            </v-btn>\n          </div>\n        </v-card-actions>\n\n        <v-card-text class=\"mt-6 pa-0\">\n          <div\n            id=\"existing-comments\"\n            class=\"pr-5\"\n          >\n            <div\n              v-for=\"(comment, i) in comments\"\n              :key=\"i\"\n              class=\"text-body-2\"\n            >\n              <p\n                class=\"pre-line\"\n                v-html=\"comment.comment\"\n              />\n              <p class=\"font-italic\">\n                {{ comment.submitterDisplayName }}\n                &hyphen;\n                {{ apiToPacificDateTime(comment.timestamp) }}\n              </p>\n            </div>\n          </div>\n        </v-card-text>\n      </v-card>\n    </v-menu>\n  </div>\n</template>\n\n<script lang=\"ts\">\nimport Vue from 'vue'\nimport { Component, Mixins, Prop } from 'vue-property-decorator'\nimport { CommentIF, FormIF } from '@bcrs-shared-components/interfaces'\nimport { DateMixin } from '@/mixins' // NB: local mixin (StoryBook can't find it otherwise)\n\n@Component({})\nexport default class StaffComments extends Mixins(DateMixin) {\n  $refs!: Vue['$refs'] & {\n    textarea: FormIF\n  }\n\n  @Prop({ required: true }) readonly axios!: any\n  @Prop({ required: true }) readonly businessId!: string\n  @Prop({ default: null }) readonly url!: string // pass URL if need to override\n  @Prop({ default: 33 }) readonly nudgeTop!: number\n  @Prop({ default: 20 }) readonly nudgeLeft!: number\n  @Prop({ default: 4096 }) readonly maxLength!: number\n\n  /** Model property for v-menu (ie, whether to show the panel). */\n  private showComments = false\n\n  /** The list of comments. */\n  private comments: Array<CommentIF> = []\n\n  /** The new comment's text. */\n  private comment: string = null\n\n  /** Whether a comment is being saved. */\n  private isSaving = false\n\n  /** The number of chars remaining in the new comment. */\n  get charsRemaining (): number {\n    const length = this.comment ? this.comment.length : 0 // comment may be null\n    return (this.maxLength - length)\n  }\n\n  /** The Number of Comments string for this entity. */\n  get numComments (): string {\n    const numComments = this.comments.length\n    return (numComments === 1 ? '1 Comment' : `${numComments} Comments`)\n  }\n\n  /** Array of validations rules for the textarea. */\n  get rules (): Array<(v) => boolean | string> {\n    // exclude whitespace in minimum length check\n    // include whitespace in maximum length check\n    return [\n      val => (val && val.trim().length > 0) || 'Enter a comment.',\n      val => (val && val.length <= this.maxLength) || 'Maximum characters reached.'\n    ]\n  }\n  /** get Endpoint URL. */\n  get getUrl (): string {\n    return this.url || `businesses/${this.businessId}/comments`\n  }\n\n  /** Called when component is created. */\n  async created (): Promise<void> {\n    await this.fetchStaffComments()\n  }\n\n  /** Fetches the staff comments from the API. */\n  private async fetchStaffComments (): Promise<void> {\n    this.comments = await this.axios.get(this.getUrl)\n      .then(res => {\n        const comments = (res && res.data && res.data.comments) || []\n        // if comments is array of object with 'comment as key' flatten structure\n        if (Array.isArray(comments) && comments[0] && typeof comments[0].comment === 'string') {\n          return comments\n        }\n        return this.flattenAndSortComments(comments)\n      })\n      .catch(() => [])\n  }\n\n  /** Saves the new comment to the API. */\n  protected async save (): Promise<void> {\n    // don't save if invalid\n    if (!this.$refs.textarea.validate()) return\n\n    // prevent double saving\n    if (this.isSaving) return\n    this.isSaving = true\n\n    const data = {\n      comment: {\n        businessId: this.businessId,\n        comment: this.comment\n      }\n    }\n\n    let success = false\n    await this.axios.post(this.getUrl, data).then(res => {\n      success = true\n    }).catch(error => {\n      // eslint-disable-next-line no-console\n      console.log('save() error =', error)\n      alert('Could not save your comment. Please try again or cancel.')\n    })\n\n    this.isSaving = false\n    if (success) {\n      // clear the data and reload the staff comments\n      this.$refs.textarea.reset()\n      await this.fetchStaffComments()\n    }\n  }\n\n  /** Closes the menu (panel). */\n  protected close (): void {\n    // clear any errors; leave the data\n    this.$refs.textarea.resetValidation()\n    this.showComments = false\n  }\n\n  /**\n   * Flattens and sorts an array of comments.\n   * @param comments the array of comments to sort and deconstruct\n   * @returns the sorted and flattened array of comments\n   */\n  private flattenAndSortComments (comments: Array<any>): Array<any> {\n    if (comments && comments.length > 0) {\n      // first use map to change comment.comment to comment\n      const temp: Array<any> = comments.map(c => c.comment)\n      // then sort newest to oldest\n      temp.sort((a, b) => new Date(a.timestamp) < new Date(b.timestamp) ? 1 : -1)\n      return temp\n    }\n    return []\n  }\n}\n</script>\n\n<style lang=\"scss\" scoped>\n@import '@/assets/styles/theme.scss';\n\n#staff-comment-container {\n  width: 33rem;\n  height: 36rem;\n  overflow: hidden;\n}\n\n.v-card__title {\n  .v-icon {\n    margin-top: 1px;\n  }\n\n  span {\n    color: $app-blue;\n    font-size: 0.75rem;\n    letter-spacing: normal;\n    margin-left: 5px;\n  }\n}\n\n:deep() {\n  .v-textarea textarea {\n    font-size: 0.875rem !important;\n    color: $gray7 !important;\n\n    &::placeholder {\n      color: $gray7 !important;\n    }\n  }\n\n  // reduce overall textarea height when there are no error messages\n  .v-textarea:not(.error--text) {\n    margin-bottom: -24px;\n  }\n\n  // reduce overall textarea height when there are errors messages\n  .v-textarea.error--text {\n    margin-bottom: -12px;\n  }\n\n  // shrink input area to make space for error messages\n  .v-textarea.error--text textarea {\n    height: calc(140px - 12px) !important;\n  }\n}\n\n.v-card__actions .body-2 {\n  color: $gray7;\n}\n\n#existing-comments {\n  height: 16rem;\n  max-height: 16rem;\n  overflow-y: scroll;\n  text-align: left;\n\n  .body-2 {\n    color: $gray7;\n    line-height: 1.375rem;\n  }\n\n  .body-2 + .body-2 {\n    margin-top: 1rem;\n    padding-top: 1rem;\n    border-top: 1px solid $gray7;\n    border-radius: 0;\n  }\n}\n</style>\n"],"names":["StaffComments","Mixins","DateMixin","__publicField","length","numComments","val","res","comments","data","success","error","temp","c","a","b","__decorateClass","Prop","Component"],"mappings":"4pBAsIA,IAAAA,EAAA,cAAAC,EAAAC,CAAA,CAAA,CAAA,kCACAC,EAAA,cAIAA,EAAA,cACAA,EAAA,mBACAA,EAAA,YACAA,EAAA,iBACAA,EAAA,kBACAA,EAAA,kBAGAA,EAAA,oBAAA,IAGAA,EAAA,gBAAA,CAAA,GAGAA,EAAA,eAAA,MAGAA,EAAA,gBAAA,IAGA,IAAA,gBAAA,CACA,MAAAC,EAAA,KAAA,QAAA,KAAA,QAAA,OAAA,EACA,OAAA,KAAA,UAAAA,CACA,CAGA,IAAA,aAAA,CACA,MAAAC,EAAA,KAAA,SAAA,OACA,OAAAA,IAAA,EAAA,YAAA,GAAAA,CAAA,WACA,CAGA,IAAA,OAAA,CAGA,MAAA,IACAC,GAAAA,EAAA,KAAA,EAAA,OAAA,GAAA,mBACAA,GAAAA,GAAAA,EAAA,QAAA,KAAA,WAAA,6BAAA,CAEA,CAEA,IAAA,QAAA,CACA,OAAA,KAAA,KAAA,cAAA,KAAA,UAAA,WACA,CAGA,MAAA,SAAA,CACA,MAAA,KAAA,oBACA,CAGA,MAAA,oBAAA,CACA,KAAA,SAAA,MAAA,KAAA,MAAA,IAAA,KAAA,MAAA,EACA,KAAAC,GAAA,CACA,MAAAC,EAAAD,GAAAA,EAAA,MAAAA,EAAA,KAAA,UAAA,GAEA,OAAA,MAAA,QAAAC,CAAA,GAAAA,EAAA,CAAA,GAAA,OAAAA,EAAA,CAAA,EAAA,SAAA,SACAA,EAEA,KAAA,uBAAAA,CAAA,CAAA,CACA,EACA,MAAA,IAAA,CAAA,CAAA,CACA,CAGA,MAAA,MAAA,CAKA,GAHA,CAAA,KAAA,MAAA,SAAA,SAAA,GAGA,KAAA,SAAA,OACA,KAAA,SAAA,GAEA,MAAAC,EAAA,CACA,QAAA,CACA,WAAA,KAAA,WACA,QAAA,KAAA,OACA,CAAA,EAGA,IAAAC,EAAA,GACA,MAAA,KAAA,MAAA,KAAA,KAAA,OAAAD,CAAA,EAAA,KAAAF,GAAA,CACAG,EAAA,EAAA,CACA,EAAA,MAAAC,GAAA,CAEA,QAAA,IAAA,iBAAAA,CAAA,EACA,MAAA,0DAAA,CAAA,CACA,EAEA,KAAA,SAAA,GACAD,IAEA,KAAA,MAAA,SAAA,QACA,MAAA,KAAA,qBAEA,CAGA,OAAA,CAEA,KAAA,MAAA,SAAA,kBACA,KAAA,aAAA,EACA,CAOA,uBAAAF,EAAA,CACA,GAAAA,GAAAA,EAAA,OAAA,EAAA,CAEA,MAAAI,EAAAJ,EAAA,IAAAK,GAAAA,EAAA,OAAA,EAEA,OAAAD,EAAA,KAAA,CAAAE,EAAAC,IAAA,IAAA,KAAAD,EAAA,SAAA,EAAA,IAAA,KAAAC,EAAA,SAAA,EAAA,EAAA,EAAA,EACAH,CACA,CACA,MAAA,EACA,CACA,EAvHAI,EAAA,CAAAC,EAAA,CAAA,SAAA,GAAA,CAAA,EALAjB,EAKA,UAAA,QAAA,CAAA,EACAgB,EAAA,CAAAC,EAAA,CAAA,SAAA,GAAA,CAAA,EANAjB,EAMA,UAAA,aAAA,CAAA,EACAgB,EAAA,CAAAC,EAAA,CAAA,QAAA,KAAA,CAAA,EAPAjB,EAOA,UAAA,MAAA,CAAA,EACAgB,EAAA,CAAAC,EAAA,CAAA,QAAA,GAAA,CAAA,EARAjB,EAQA,UAAA,WAAA,CAAA,EACAgB,EAAA,CAAAC,EAAA,CAAA,QAAA,GAAA,CAAA,EATAjB,EASA,UAAA,YAAA,CAAA,EACAgB,EAAA,CAAAC,EAAA,CAAA,QAAA,KAAA,CAAA,EAVAjB,EAUA,UAAA,YAAA,CAAA,EAVAA,EAAAgB,EAAA,CADAE,EAAA,CAAA,CAAA,CAAA,EACAlB,CAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;"}